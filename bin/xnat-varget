#!/usr/bin/env python
"""
Gets the value of a variable (custom or otherwise) of a session or subject in a
MBI-XNAT project

User credentials can be stored in a ~/.netrc file so that they don't need to be
entered each time a command is run. If a new user provided or netrc doesn't
exist the tool will ask whether to create a ~/.netrc file with the given
credentials.
"""
from __future__ import print_function
import argparse
import re
from xnatutils import connect

parser = argparse.ArgumentParser(__doc__)
parser.add_argument('subject_or_session_id', type=str,
                    help="Name of subject or session to set the variable of")
parser.add_argument('variable', type=str,
                    help="Name of the variable to set")
parser.add_argument('--default', type=str, default='',
                    help="Default value if object does not have a value")
args = parser.parse_args()

with connect() as mbi_xnat:
    
    # Get XNAT object to set the field of
    if args.subject_or_session_id.count('_') == 1:
        xnat_obj = mbi_xnat.subjects[args.subject_or_session_id]
    elif args.subject_or_session_id.count('_') == 2:
        xnat_obj = mbi_xnat.experiments[args.subject_or_session_id]
    else:
        raise XnatUtilsUsageError(
            "Invalid ID '{}' for subject or sessions (must contain one "
            "underscore for subjects and two underscores for sessions)"
            .format(args.subject_or_session_id))
    # Get value
    try:
        print(xnat_obj.fields[args.variable], end='')
    except KeyError:
        print(args.default, end='')